<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <iframe id="container" width="700px" height="1000px">
    </iframe>
    <script>
        var scrollElement = {}
        fetch('/replayInfo', {
            method: "GET"
        }).then((data) => {
            return data.json();
        }).then((data) => {
            let css = data.css;
            let htmlArr = data.html;
            let scrollArr = data.scroll;
            oneFrame(css, 0, htmlArr);
            scrollOffsetTime = scrollArr[0].utc - htmlArr[0].utc 

            setTimeout(function(){
                moveScroll(0, scrollArr);
            },scrollOffsetTime)
            
        })

        function oneFrame(css, i, htmlArr) {
            // let css = css
            var html = htmlArr[i].html.replace(/<script[\s\S]*script>/g, "")
            var containerWindow = document.getElementById('container').contentWindow
            var container = containerWindow.document;
            container.getElementsByTagName('html')[0].innerHTML = html
            var links = container.getElementsByTagName('link')
            var body = container.getElementsByTagName('body')[0];            

            var elements = Object.getOwnPropertyNames(scrollElement);
            for (let e of elements) {
                var element
                if (e == 'window') {
                    element = containerWindow
                } else {
                    element = container.getElementById(e);
                }
                var x = scrollElement[e].x
                var y = scrollElement[e].y
                element.scrollTo(x, y)
            }

            while (links.length) {
                links[0].remove()
            }
            var style = container.createElement('style');
            style.type = 'text/css';
            style.innerHTML = css.css;
            var containerHead = container.getElementsByTagName('head').item(0);
            containerHead.insertBefore(style, containerHead.firstChild);
            i++;
            if (i == htmlArr.length) {
                return;
            }
            var time = htmlArr[i].utc - htmlArr[i - 1].utc


            setTimeout(function () {
                oneFrame(css, i, htmlArr)
            }, time);
        }

        function moveScroll(i, scrollArr) {
            var scroll = scrollArr[i];
            // console.log(scroll)
            var containerWindow = document.getElementById('container').contentWindow
            var container = containerWindow.document;
            var scrollInfo = scroll['scroll'];
            scrollElement = scrollInfo
            var elements = Object.getOwnPropertyNames(scrollInfo);


            for (let e of elements) {
                let element;
                let offsetX;
                let offsetY;
                var x = scrollInfo[e].x;
                var y = scrollInfo[e].y;
                if (e == 'window') {
                    element = containerWindow;
                    offsetY = (y - element.scrollY) / 100;
                    offsetX = (x - element.scrollX) / 100;
                } else {
                    element = container.getElementById(e);
                    offsetY = (y - element.scrollTop) / 100;
                    offsetX = (x - element.scrollLeft) / 100;
                }
                // console.log(offsetY)
                for (let j = 1; j <= 100; j++) {
                    let elementX;
                    let elementY;

                    setTimeout(function () {
                        if (e == 'window') {
                            elementX = element.scrollX;
                            elementY = element.scrollY;
                        } else {
                            elementX = element.scrollLeft;
                            elementY = element.scrollTop;
                        }
                        // console.log(element)
                        let moveX = elementX + offsetX;
                        let moveY = elementY + offsetY
                        element.scrollTo(moveX, moveY)
                        scrollElement[e].y = elementY
                        scrollElement[e].x = elementX
                    }, 5 * j)
                }
                // element.scrollTo(x, y)
            }
            i++;
            if (i == scrollArr.length) {
                return
            }
            var time = scrollArr[i].utc - scrollArr[i - 1].utc

            setTimeout(function () {
                moveScroll(i, scrollArr)
            }, time)
        }
    </script>
</body>

</html>